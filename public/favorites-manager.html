<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeamNL Cloud9 - Favorites Manager</title>
  
  <!-- Tailwind CSS via CDN (100% gratis) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold">🏁 TeamNL Cloud9 - Favorites Manager</h1>
          <p class="text-blue-200 mt-2">Beheer je favorite riders - Geen CLI nodig!</p>
        </div>
        <a href="/scheduler-config.html" class="bg-white text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-50 transition font-semibold flex items-center space-x-2">
          <span>⚙️</span>
          <span>Scheduler Config</span>
        </a>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- Status Bar -->
    <div id="status-bar" class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600" id="total-favorites">0</div>
          <div class="text-sm text-gray-600">Total Favorites</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-yellow-600" id="queue-pending">0</div>
          <div class="text-sm text-gray-600">🟡 Wachtend</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600" id="queue-processing">0</div>
          <div class="text-sm text-gray-600">🔵 Bezig</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-green-600" id="queue-completed">0</div>
          <div class="text-sm text-gray-600">🟢 Voltooid</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-red-600" id="queue-failed">0</div>
          <div class="text-sm text-gray-600">🔴 Gefaald</div>
        </div>
      </div>
      
      <!-- Worker Status -->
      <div class="mt-4 pt-4 border-t flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-600">Worker Status:</span>
          <span id="worker-status" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
            ✓ Actief
          </span>
        </div>
        <div class="flex items-center space-x-3">
          <button 
            id="pause-worker-btn" 
            class="px-4 py-2 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold transition"
            onclick="pauseWorker()"
          >
            ⏸️ Pauzeer
          </button>
          <button 
            id="resume-worker-btn" 
            class="px-4 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold transition hidden"
            onclick="resumeWorker()"
          >
            ▶️ Hervat
          </button>
          <button 
            id="retry-all-btn" 
            class="px-4 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold transition"
            onclick="retryAllFailed()"
          >
            🔄 Retry Failed
          </button>
        </div>
      </div>
    </div>
    
    <!-- Queue Jobs Section -->
    <div id="queue-section" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">📋 Queue Status</h2>
        <button 
          onclick="clearCompletedJobs()" 
          class="text-sm text-gray-600 hover:text-gray-900"
        >
          🗑️ Clear Completed
        </button>
      </div>
      
      <!-- Queue Jobs List -->
      <div id="queue-jobs-container" class="space-y-2 max-h-96 overflow-y-auto">
        <!-- Dynamic content -->
      </div>
    </div>

    <!-- Add Favorite Section -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">➕ Favorite Toevoegen</h2>
      
      <!-- Single Add Form -->
      <div class="mb-6">
        <h3 class="font-semibold mb-3">Enkele Rider</h3>
        <form id="add-single-form" class="flex flex-col md:flex-row gap-3">
          <input 
            type="number" 
            id="zwift-id" 
            placeholder="Zwift ID (bijv. 1495)" 
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
          >
          <select 
            id="priority" 
            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="1">Priority 1 (Hoogste)</option>
            <option value="2">Priority 2</option>
            <option value="3">Priority 3</option>
            <option value="4">Priority 4 (Laagste)</option>
          </select>
          <button 
            type="submit" 
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold transition"
          >
            Toevoegen
          </button>
        </form>
      </div>

      <!-- Bulk Upload -->
      <div>
        <h3 class="font-semibold mb-3">Bulk Upload (CSV/TXT)</h3>
        <div 
          id="drop-zone" 
          class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer"
        >
          <div class="mb-3">
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
              <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>
          <p class="text-gray-600 mb-2">Sleep bestand hierheen of klik om te uploaden</p>
          <p class="text-sm text-gray-500">TXT of CSV met één Zwift ID per regel</p>
          <input type="file" id="file-input" accept=".txt,.csv" class="hidden">
        </div>
        <div class="mt-3 flex gap-3">
          <select 
            id="bulk-priority" 
            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="2">Priority 2 (standaard voor bulk)</option>
            <option value="1">Priority 1</option>
            <option value="3">Priority 3</option>
            <option value="4">Priority 4</option>
          </select>
          <button 
            id="upload-btn" 
            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold transition disabled:bg-gray-400"
            disabled
          >
            Upload & Toevoegen
          </button>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex flex-wrap gap-3">
        <button 
          id="sync-all-btn" 
          class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 font-semibold transition flex items-center gap-2"
        >
          <span id="sync-icon">🔄</span>
          <span id="sync-text">Sync Alle Favorites</span>
        </button>
        <button 
          id="e2e-test-btn" 
          class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold transition flex items-center gap-2"
        >
          <span id="e2e-icon">🧪</span>
          <span id="e2e-text">End-to-End Test</span>
        </button>
        <button 
          id="refresh-btn" 
          class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 font-semibold transition"
        >
          ♻️ Ververs Lijst
        </button>
      </div>
    </div>

    <!-- Favorites Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-xl font-bold">📋 Mijn Favorites (<span id="favorites-count">0</span>)</h2>
        <input 
          type="text" 
          id="search-input" 
          placeholder="Zoek op naam of ID..." 
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-64"
        >
      </div>
      
      <div id="loading" class="p-12 text-center hidden">
        <div class="inline-block h-12 w-12 border-4 border-blue-600 border-t-transparent rounded-full spinner"></div>
        <p class="mt-4 text-gray-600">Laden...</p>
      </div>
      
      <div id="empty-state" class="p-12 text-center hidden">
        <p class="text-gray-500 text-lg">Nog geen favorites toegevoegd</p>
        <p class="text-gray-400 mt-2">Voeg je eerste favorite rider toe hierboven!</p>
      </div>
      
      <div id="favorites-table-container" class="overflow-x-auto">
        <table id="favorites-table" class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="zwiftId">
                Zwift ID ↕
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="name">
                Naam ↕
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="ftp">
                FTP ↕
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="syncPriority">
                Priority ↕
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Rating
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Type
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Acties
              </th>
            </tr>
          </thead>
          <tbody id="favorites-tbody" class="bg-white divide-y divide-gray-200">
            <!-- Dynamisch gevuld via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-24 transition-transform duration-300 hidden">
      <p id="toast-message"></p>
    </div>

  </div>

  <script>
    // ============================================
    // STATE & CONFIG
    // ============================================
    const API_BASE = window.location.origin + '/api';
    let favorites = [];
    let sortField = 'syncPriority';
    let sortDirection = 'asc';
    let uploadedFile = null;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.classList.remove('bg-gray-800', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
      
      if (type === 'success') toast.classList.add('bg-green-600');
      else if (type === 'error') toast.classList.add('bg-red-600');
      else if (type === 'info') toast.classList.add('bg-blue-600');
      else toast.classList.add('bg-gray-800');
      
      toast.classList.remove('hidden');
      toast.style.transform = 'translateY(0)';
      
      setTimeout(() => {
        toast.style.transform = 'translateY(24rem)';
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, 3000);
    }

    function getPriorityBadge(priority) {
      const badges = {
        1: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">1 🔴</span>',
        2: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">2 🟡</span>',
        3: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">3 🟢</span>',
        4: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">4 🔵</span>'
      };
      return badges[priority] || badges[4];
    }

    function formatDate(dateString) {
      if (!dateString) return 'Nooit';
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'Zojuist';
      if (diffMins < 60) return `${diffMins} min geleden`;
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours} uur geleden`;
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays} dag${diffDays > 1 ? 'en' : ''} geleden`;
    }

    // ============================================
    // API CALLS
    // ============================================
    async function loadFavorites() {
      try {
        document.getElementById('loading').classList.remove('hidden');
        
        const response = await fetch(`${API_BASE}/subteam/riders`);
        if (!response.ok) throw new Error('Kon favorites niet laden');
        
        const data = await response.json();
        favorites = data.riders || data;
        renderFavorites();
        updateStatusBar();
        
        document.getElementById('loading').classList.add('hidden');
      } catch (error) {
        console.error('Error loading favorites:', error);
        showToast('Fout bij laden favorites: ' + error.message, 'error');
        document.getElementById('loading').classList.add('hidden');
      }
    }

    async function addFavorite(zwiftId, priority, addedBy = 'gui') {
      try {
        const response = await fetch(`${API_BASE}/subteam/riders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ zwiftIds: [zwiftId] })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Kon favorite niet toevoegen');
        }
        
        const result = await response.json();
        showToast(`✓ Rider ${zwiftId} toegevoegd! Job ID: ${result.jobId}`, 'success');
        
        // Immediately fetch queue status to show the new job
        await fetchQueueStatus();
        
        // Reload favorites after a short delay (to show instant feedback)
        setTimeout(loadFavorites, 2000);
        
        return true;
      } catch (error) {
        console.error('Error adding favorite:', error);
        showToast('Fout: ' + error.message, 'error');
        return false;
      }
    }

    async function deleteFavorite(zwiftId) {
      if (!confirm(`Weet je zeker dat je rider ${zwiftId} wilt verwijderen?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/subteam/riders/${zwiftId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Kon favorite niet verwijderen');
        
        showToast(`Rider ${zwiftId} verwijderd`, 'success');
        await loadFavorites();
      } catch (error) {
        console.error('Error deleting favorite:', error);
        showToast('Fout: ' + error.message, 'error');
      }
    }

    async function updatePriority(zwiftId, newPriority) {
      try {
        // TODO: Priority update not yet implemented in SubteamService
        // For now, riders are always added with default priority
        showToast('Priority updates niet ondersteund (nog niet geïmplementeerd)', 'warning');
        return;
        
        /*
        const response = await fetch(`${API_BASE}/favorites/${zwiftId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priority: newPriority })
        });
        
        if (!response.ok) throw new Error('Kon priority niet updaten');
        
        showToast(`Priority bijgewerkt naar ${newPriority}`, 'success');
        await loadFavorites();
        */
      } catch (error) {
        console.error('Error updating priority:', error);
        showToast('Fout: ' + error.message, 'error');
      }
    }

    async function triggerSync() {
      const btn = document.getElementById('sync-all-btn');
      const icon = document.getElementById('sync-icon');
      const text = document.getElementById('sync-text');
      
      btn.disabled = true;
      icon.textContent = '⏳';
      text.textContent = 'Bezig met syncen...';
      
      try {
        const response = await fetch(`${API_BASE}/subteam/sync`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('Sync gefaald');
        
        const result = await response.json();
        
        showToast(
          `✓ Sync voltooid! ${result.synced || 0} riders gesynchroniseerd.`, 
          'success'
        );
        
        // Refresh data na 2 seconden
        setTimeout(loadFavorites, 2000);
      } catch (error) {
        console.error('Error triggering sync:', error);
        showToast('Fout bij syncen: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        icon.textContent = '🔄';
        text.textContent = 'Sync Alle Favorites';
      }
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function renderFavorites() {
      const tbody = document.getElementById('favorites-tbody');
      const emptyState = document.getElementById('empty-state');
      const tableContainer = document.getElementById('favorites-table-container');
      
      // Filter based on search
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      let filtered = favorites.filter(f => 
        f.name?.toLowerCase().includes(searchTerm) || 
        f.zwiftId.toString().includes(searchTerm)
      );
      
      // Sort
      filtered.sort((a, b) => {
        let aVal = a[sortField];
        let bVal = b[sortField];
        
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        if (typeof aVal === 'string') {
          return sortDirection === 'asc' 
            ? aVal.localeCompare(bVal) 
            : bVal.localeCompare(aVal);
        }
        
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      });
      
      if (filtered.length === 0) {
        emptyState.classList.remove('hidden');
        tableContainer.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        tableContainer.classList.remove('hidden');
      }
      
      tbody.innerHTML = filtered.map(fav => `
        <tr class="hover:bg-gray-50 transition">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
            ${fav.zwiftId}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${fav.name || '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            ${fav.ftp ? fav.ftp + 'W' : '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <select 
              class="priority-select text-sm border-0 focus:ring-2 focus:ring-blue-500 rounded" 
              data-zwift-id="${fav.zwiftId}"
              data-current="${fav.syncPriority || 1}"
            >
              <option value="1" ${(fav.syncPriority || 1) === 1 ? 'selected' : ''}>1 🔴</option>
              <option value="2" ${(fav.syncPriority || 1) === 2 ? 'selected' : ''}>2 🟡</option>
              <option value="3" ${(fav.syncPriority || 1) === 3 ? 'selected' : ''}>3 🟢</option>
              <option value="4" ${(fav.syncPriority || 1) === 4 ? 'selected' : ''}>4 🔵</option>
            </select>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            ${fav.raceRating?.currentRating ? Math.round(fav.raceRating.currentRating) : '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            ${fav.phenotype?.primaryType || '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
            <button 
              onclick="deleteFavorite(${fav.zwiftId})" 
              class="text-red-600 hover:text-red-900 font-semibold ml-3"
              title="Verwijder"
            >
              🗑️
            </button>
          </td>
        </tr>
      `).join('');
      
      // Add event listeners to priority selects
      document.querySelectorAll('.priority-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const zwiftId = parseInt(e.target.dataset.zwiftId);
          const newPriority = parseInt(e.target.value);
          const oldPriority = parseInt(e.target.dataset.current);
          
          if (newPriority !== oldPriority) {
            updatePriority(zwiftId, newPriority);
          }
        });
      });
      
      document.getElementById('favorites-count').textContent = filtered.length;
    }

    function updateStatusBar() {
      document.getElementById('total-favorites').textContent = favorites.length;
    }
    
    // Queue status polling
    let queueStatus = {
      pending: 0,
      processing: 0,
      completed: 0,
      failed: 0,
      isPaused: false,
      jobs: []
    };
    
    async function fetchQueueStatus() {
      try {
        const response = await fetch(`${API_BASE}/queue/status`);
        if (!response.ok) throw new Error('Queue status niet beschikbaar');
        
        const data = await response.json();
        queueStatus = data;
        
        // Update counters
        document.getElementById('queue-pending').textContent = data.pending;
        document.getElementById('queue-processing').textContent = data.processing;
        document.getElementById('queue-completed').textContent = data.completed;
        document.getElementById('queue-failed').textContent = data.failed;
        
        // Update worker status
        const workerStatus = document.getElementById('worker-status');
        const pauseBtn = document.getElementById('pause-worker-btn');
        const resumeBtn = document.getElementById('resume-worker-btn');
        
        if (data.isPaused) {
          workerStatus.textContent = '⏸️ Gepauzeerd';
          workerStatus.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800';
          pauseBtn.classList.add('hidden');
          resumeBtn.classList.remove('hidden');
        } else {
          workerStatus.textContent = '✓ Actief';
          workerStatus.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
          pauseBtn.classList.remove('hidden');
          resumeBtn.classList.add('hidden');
        }
        
        // Show/hide queue section
        const queueSection = document.getElementById('queue-section');
        if (data.jobs && data.jobs.length > 0) {
          queueSection.classList.remove('hidden');
          renderQueueJobs(data.jobs);
        } else {
          queueSection.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Fout bij ophalen queue status:', error);
      }
    }
    
    function renderQueueJobs(jobs) {
      const container = document.getElementById('queue-jobs-container');
      
      if (jobs.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Geen jobs in queue</p>';
        return;
      }
      
      // Sort: processing first, then pending, then failed, then completed
      const statusOrder = { processing: 1, pending: 2, failed: 3, completed: 4 };
      const sortedJobs = [...jobs].sort((a, b) => statusOrder[a.status] - statusOrder[b.status]);
      
      container.innerHTML = sortedJobs.map(job => {
        const statusConfig = {
          pending: { icon: '🟡', label: 'Wachtend', color: 'yellow' },
          processing: { icon: '🔵', label: 'Bezig', color: 'blue' },
          completed: { icon: '🟢', label: 'Voltooid', color: 'green' },
          failed: { icon: '🔴', label: 'Gefaald', color: 'red' }
        };
        
        const config = statusConfig[job.status];
        const elapsed = job.processingStartedAt 
          ? Math.round((new Date() - new Date(job.processingStartedAt)) / 1000) + 's'
          : '-';
        
        return `
          <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
            <div class="flex items-center space-x-3 flex-1">
              <span class="text-2xl">${config.icon}</span>
              <div>
                <div class="font-semibold text-gray-900">Rider #${job.riderId}</div>
                <div class="text-sm text-gray-600">
                  Priority ${job.priority} • ${config.label}
                  ${job.status === 'processing' ? ' • ' + elapsed : ''}
                  ${job.retries > 0 ? ' • Retry ' + job.retries : ''}
                </div>
                ${job.error ? `<div class="text-xs text-red-600 mt-1">${job.error}</div>` : ''}
              </div>
            </div>
            <div class="flex items-center space-x-2">
              ${job.status === 'pending' ? `
                <button 
                  onclick="cancelJob('${job.id}')" 
                  class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                  title="Annuleer"
                >
                  ✕
                </button>
              ` : ''}
              ${job.status === 'failed' ? `
                <button 
                  onclick="retryJob('${job.id}')" 
                  class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600"
                  title="Retry"
                >
                  🔄
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Queue control functions
    async function pauseWorker() {
      try {
        const response = await fetch(`${API_BASE}/queue/pause`, { method: 'POST' });
        if (response.ok) {
          showToast('Worker gepauzeerd', 'success');
          await fetchQueueStatus();
        }
      } catch (error) {
        showToast('Fout bij pauzeren worker', 'error');
      }
    }
    
    async function resumeWorker() {
      try {
        const response = await fetch(`${API_BASE}/queue/resume`, { method: 'POST' });
        if (response.ok) {
          showToast('Worker hervat', 'success');
          await fetchQueueStatus();
        }
      } catch (error) {
        showToast('Fout bij hervatten worker', 'error');
      }
    }
    
    async function retryJob(jobId) {
      try {
        const response = await fetch(`${API_BASE}/queue/retry/${jobId}`, { method: 'POST' });
        if (response.ok) {
          showToast('Job retry gestart', 'success');
          await fetchQueueStatus();
        }
      } catch (error) {
        showToast('Fout bij retry job', 'error');
      }
    }
    
    async function retryAllFailed() {
      if (queueStatus.failed === 0) {
        showToast('Geen gefaalde jobs om te retyen', 'info');
        return;
      }
      
      if (!confirm(`${queueStatus.failed} gefaalde job(s) opnieuw proberen?`)) return;
      
      try {
        const response = await fetch(`${API_BASE}/queue/retry-all`, { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          showToast(`${result.retried} job(s) opnieuw in queue`, 'success');
          await fetchQueueStatus();
        }
      } catch (error) {
        showToast('Fout bij retry all', 'error');
      }
    }
    
    async function cancelJob(jobId) {
      try {
        const response = await fetch(`${API_BASE}/queue/cancel/${jobId}`, { method: 'POST' });
        if (response.ok) {
          showToast('Job geannuleerd', 'success');
          await fetchQueueStatus();
        }
      } catch (error) {
        showToast('Fout bij annuleren job', 'error');
      }
    }
    
    async function clearCompletedJobs() {
      if (queueStatus.completed === 0) {
        showToast('Geen voltooide jobs om te verwijderen', 'info');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/queue/clear-completed`, { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          showToast(`${result.cleared} voltooide job(s) verwijderd`, 'success');
          await fetchQueueStatus();
        }
      } catch (error) {
        showToast('Fout bij verwijderen jobs', 'error');
      }
    }

    // ============================================
    // END-TO-END TEST
    // ============================================
    async function runEndToEndTest() {
      const btn = document.getElementById('e2e-test-btn');
      const icon = document.getElementById('e2e-icon');
      const text = document.getElementById('e2e-text');
      
      if (favorites.length === 0) {
        showToast('⚠️ Upload eerst favorieten voordat je test draait!', 'error');
        return;
      }
      
      const confirmed = confirm(`🧪 END-TO-END TEST

Dit test de volledige workflow:
✅ Step 1: Check favorites (${favorites.length} riders)
✅ Step 2: Sync rider stats
✅ Step 3: Extract clubs
✅ Step 4: Sync club rosters
✅ Step 5: Forward scan (5 events)

Duur: ~10-15 minuten
Kosten: €0 (gratis API)

Doorgaan?`);
      
      if (!confirmed) return;
      
      btn.disabled = true;
      icon.textContent = '⏳';
      
      const log = (msg, success = true) => {
        console.log(msg);
        showToast(msg, success ? 'info' : 'error');
      };
      
      try {
        // ===== STEP 1: Verify Favorites =====
        text.textContent = 'Step 1/5: Verify favorites...';
        log(`✅ Step 1: ${favorites.length} favorites geladen`);
        await sleep(1000);
        
        // ===== STEP 2: Sync Rider Stats =====
        text.textContent = 'Step 2/5: Sync rider stats...';
        log(`🔄 Step 2: Start sync van ${favorites.length} riders (dit duurt ~${favorites.length * 12} sec)`);
        
        const syncResponse = await fetch(`${API_BASE}/subteam/sync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!syncResponse.ok) throw new Error('Rider sync gefaald');
        
        const syncResult = await syncResponse.json();
        log(`✅ Step 2: ${syncResult.synced} riders gesynchroniseerd, ${syncResult.clubsExtracted} clubs geëxtraheerd`, true);
        await sleep(2000);
        
        // Reload to get updated data
        await loadFavorites();
        
        // ===== STEP 3: Verify Club Extraction =====
        text.textContent = 'Step 3/5: Verify clubs...';
        
        const clubsResponse = await fetch(`${API_BASE}/club`);
        if (!clubsResponse.ok) throw new Error('Kon clubs niet ophalen');
        
        const clubData = await clubsResponse.json();
        log(`✅ Step 3: ${clubData.memberCount || 0} club members in database`);
        await sleep(1000);
        
        // ===== STEP 4: Sync Club Rosters (indien nog niet gedaan) =====
        text.textContent = 'Step 4/5: Sync club rosters...';
        log('👥 Step 4: Start club rosters sync');
        
        const clubSyncResponse = await fetch(`${API_BASE}/clubs/sync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!clubSyncResponse.ok) throw new Error('Club roster sync gefaald');
        
        const clubSyncResult = await clubSyncResponse.json();
        log(`✅ Step 4: ${clubSyncResult.synced} clubs gesynchroniseerd, ${clubSyncResult.totalMembers} members`, true);
        await sleep(1000);
        
        // ===== STEP 5: Forward Event Scan (Test met 5 events) =====
        text.textContent = 'Step 5/5: Forward scan (5 events)...';
        log('🔍 Step 5: Start forward event scan (5 events, ~5 minuten)');
        
        const scanResponse = await fetch(`${API_BASE}/sync/forward`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            maxEvents: 5,
            retentionDays: 100
          })
        });
        
        if (!scanResponse.ok) throw new Error('Forward scan gefaald');
        
        const scanResult = await scanResponse.json();
        log(`✅ Step 5: ${scanResult.found} events met tracked riders, ${scanResult.saved} opgeslagen`, true);
        await sleep(1000);
        
        // ===== VERIFICATION =====
        text.textContent = 'Verificatie...';
        
        const eventsResponse = await fetch(`${API_BASE}/events/tracked?limit=10`);
        if (!eventsResponse.ok) throw new Error('Kon events niet ophalen');
        
        const eventsData = await eventsResponse.json();
        
        // ===== FINAL REPORT =====
        const report = `🎉 END-TO-END TEST GESLAAGD!

📊 Resultaten:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ Step 1: ${favorites.length} favorites
✅ Step 2: ${syncResult.synced} riders gesynchroniseerd
✅ Step 3: ${syncResult.clubsExtracted} clubs geëxtraheerd
✅ Step 4: ${clubSyncResult.synced} clubs, ${clubSyncResult.totalMembers} members
✅ Step 5: ${scanResult.scanned} events gescand
           ${scanResult.found} met tracked riders
           ${eventsData.total} events in database

⏱️ Totale tijd: ${Math.round(scanResult.duration / 1000 / 60)} minuten
💾 Database: OK
🌐 API: OK
🔄 Workflow: Compleet!

Volgende stap: Check /api/events/tracked`;
        
        alert(report);
        log('🎉 End-to-end test GESLAAGD!', true);
        
      } catch (error) {
        console.error('E2E Test error:', error);
        log('❌ Test gefaald: ' + error.message, false);
        alert('❌ Test gefaald!\n\n' + error.message + '\n\nCheck de console voor details.');
      } finally {
        btn.disabled = false;
        icon.textContent = '🧪';
        text.textContent = 'End-to-End Test';
      }
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    // Single add form
    document.getElementById('add-single-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const zwiftId = parseInt(document.getElementById('zwift-id').value);
      const priority = parseInt(document.getElementById('priority').value);
      
      const success = await addFavorite(zwiftId, priority);
      if (success) {
        document.getElementById('zwift-id').value = '';
      }
    });

    // File upload
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');

    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      
      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelect();
      }
    });
    
    fileInput.addEventListener('change', handleFileSelect);
    
    function handleFileSelect() {
      if (fileInput.files.length > 0) {
        uploadedFile = fileInput.files[0];
        dropZone.querySelector('p').textContent = `Geselecteerd: ${uploadedFile.name}`;
        uploadBtn.disabled = false;
      }
    }
    
    uploadBtn.addEventListener('click', async () => {
      if (!uploadedFile) return;
      
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Bezig met verwerken...';
      
      try {
        const text = await uploadedFile.text();
        const lines = text.split('\n')
          .map(line => line.trim())
          .filter(line => line && !line.startsWith('#') && /^\d+$/.test(line));
        
        if (lines.length === 0) {
          throw new Error('Geen geldige Zwift IDs gevonden in bestand');
        }
        
        const zwiftIds = lines.map(line => parseInt(line));
        showToast(`${zwiftIds.length} riders gevonden. Bezig met verwerken...`, 'info');
        
        // Gebruik bulk API endpoint
        const response = await fetch(`${API_BASE}/subteam/riders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ zwiftIds })
        });
        
        if (!response.ok) {
          throw new Error('Upload gefaald');
        }
        
        const result = await response.json();
        
        // Toon gedetailleerd resultaat
        let message = `Upload voltooid!\n`;
        if (result.summary?.added > 0) message += `✅ Nieuw toegevoegd: ${result.summary.added}\n`;
        if (result.summary?.updated > 0) message += `🔄 Bijgewerkt: ${result.summary.updated}\n`;
        if (result.summary?.alreadyExists > 0) message += `ℹ️  Al favoriet: ${result.summary.alreadyExists}\n`;
        if (result.summary?.failed > 0) message += `❌ Gefaald: ${result.summary.failed}`;
        
        // Toon welke clubs zijn gewijzigd
        const clubChanged = result.riders?.filter(r => r.clubChanged);
        if (clubChanged && clubChanged.length > 0) {
          message += `\n⚠️  Club gewijzigd voor ${clubChanged.length} rider(s)`;
        }
        
        showToast(message, result.summary?.failed === 0 ? 'success' : 'warning');
        
        // Reload favorites om updates te tonen
        await loadFavorites();
        
        // Reset
        fileInput.value = '';
        uploadedFile = null;
        dropZone.querySelector('p').textContent = 'Sleep bestand hierheen of klik om te uploaden';
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Upload & Toevoegen';
        
      } catch (error) {
        showToast('Fout bij verwerken bestand: ' + error.message, 'error');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload & Toevoegen';
      }
    });

    // Sync button
    document.getElementById('sync-all-btn').addEventListener('click', triggerSync);

    // End-to-End Test button
    document.getElementById('e2e-test-btn').addEventListener('click', runEndToEndTest);

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', loadFavorites);

    // Search
    document.getElementById('search-input').addEventListener('input', renderFavorites);

    // Table sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.sort;
        if (sortField === field) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDirection = 'asc';
        }
        renderFavorites();
      });
    });

    // ============================================
    // INITIALIZATION
    // ============================================
    loadFavorites();
    fetchQueueStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(loadFavorites, 30000);
    
    // Poll queue status every 5 seconds
    setInterval(fetchQueueStatus, 5000);
  </script>

</body>
</html>
