name: Railway Sync Scheduler (Hybrid Mode)

# Deze workflow triggert syncs op Railway via POST requests
# Railway kan slapen tussen syncs ‚Üí lagere kosten (~$0.20/maand)
# GitHub Actions is gratis (2000 min/maand)

on:
  schedule:
    # RIDER_SYNC: Elke 6 uur om :00
    - cron: '0 */6 * * *'
    
    # NEAR_EVENT_SYNC: 4x per uur om :05, :20, :35, :50
    - cron: '5 * * * *'
    - cron: '20 * * * *'
    - cron: '35 * * * *'
    - cron: '50 * * * *'
    
    # FAR_EVENT_SYNC: Elke 2 uur om :30
    - cron: '30 */2 * * *'
  
  workflow_dispatch: # Manual trigger via GitHub UI

env:
  RAILWAY_URL: ${{ secrets.RAILWAY_URL }} # https://jouw-app.up.railway.app

jobs:
  # Job 1: Rider Sync (elke 6 uur)
  rider-sync:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */6 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Wake Railway & Trigger Rider Sync
        run: |
          echo "üöÄ Triggering RIDER_SYNC..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Cron" \
            "${{ env.RAILWAY_URL }}/api/sync/rider")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Rider sync completed"
            echo "$body" | jq '.'
          else
            echo "‚ùå Rider sync failed (HTTP $http_code)"
            echo "$body"
            exit 1
          fi

  # Job 2: Near Event Sync (4x per uur)
  near-event-sync:
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '5 * * * *' || 
      github.event.schedule == '20 * * * *' || 
      github.event.schedule == '35 * * * *' || 
      github.event.schedule == '50 * * * *' ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Wake Railway & Trigger Near Event Sync
        run: |
          echo "üöÄ Triggering NEAR_EVENT_SYNC..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            "${{ env.RAILWAY_URL }}/api/sync/events/near")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Near event sync completed"
            echo "$body" | jq -r '.metrics | "Events: \(.events_scanned), Signups: \(.signups_synced)"'
          else
            echo "‚ùå Near event sync failed (HTTP $http_code)"
            exit 1
          fi

  # Job 3: Far Event Sync (elke 2 uur)
  far-event-sync:
    runs-on: ubuntu-latest
    if: github.event.schedule == '30 */2 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Wake Railway & Trigger Far Event Sync
        run: |
          echo "üöÄ Triggering FAR_EVENT_SYNC (48h lookforward)..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"lookforwardHours": 48, "force": false}' \
            "${{ env.RAILWAY_URL }}/api/sync/events/far")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Far event sync completed"
            echo "$body" | jq -r '.metrics | "Far: \(.events_far), Signups: \(.signups_synced), Duration: \(.duration_ms)ms"'
          else
            echo "‚ùå Far event sync failed (HTTP $http_code)"
            exit 1
          fi

  # Weekly full refresh (zondag 03:00)
  weekly-refresh:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 0' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Full Week Refresh (168h lookforward)
        run: |
          echo "üóìÔ∏è Weekly refresh: Loading 7 days ahead..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"lookforwardHours": 168, "force": false}' \
            "${{ env.RAILWAY_URL }}/api/sync/events/far")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Weekly refresh completed"
            echo "$body" | jq '.'
          else
            echo "‚ùå Weekly refresh failed"
            exit 1
          fi
