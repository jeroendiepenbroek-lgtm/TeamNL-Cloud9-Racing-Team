<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider 150437 - Data Verificatie</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .status.loading { background: #fef3c7; color: #92400e; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        tr:hover {
            background: #f9fafb;
        }
        .match { color: #059669; font-weight: 600; }
        .mismatch { color: #dc2626; font-weight: 600; }
        .missing { color: #f59e0b; font-weight: 600; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-box {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .stat-label {
            font-size: 0.875em;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #111827;
        }
        .comparison {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .comparison-item {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            background: #f9fafb;
        }
        .comparison-item.db { border-left: 4px solid #3b82f6; }
        .comparison-item.api { border-left: 4px solid #8b5cf6; }
        .comparison-label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 5px;
        }
        .comparison-label.db { color: #3b82f6; }
        .comparison-label.api { color: #8b5cf6; }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.match { background: #059669; }
        .legend-dot.mismatch { background: #dc2626; }
        .legend-dot.missing { background: #f59e0b; }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
            .comparison {
                flex-direction: column;
            }
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Rider Data Verificatie</h1>
        <p class="subtitle">Rider ID: 150437 (JR√∏ne | CloudRacer-9 @YouTube)</p>
        
        <div class="card">
            <span id="status" class="status loading">‚è≥ Laden...</span>
            <div id="sync-info" style="margin-top: 10px; color: #6b7280;"></div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px;">üìä Basis Gegevens</h2>
            <div id="basic-info"></div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px;">‚ö° Power Intervallen</h2>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot match"></div>
                    <span>Match</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot mismatch"></div>
                    <span>Verschil</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot missing"></div>
                    <span>Ontbreekt</span>
                </div>
            </div>
            <div id="power-data"></div>
        </div>

        <button class="refresh-btn" onclick="loadData()">üîÑ Ververs Data</button>
    </div>

    <script>
        const RIDER_ID = 150437;
        const API_BASE = '/api';
        const ZWIFT_API = 'https://zwift-ranking.herokuapp.com/api';

        async function loadData() {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status loading';
            statusEl.textContent = '‚è≥ Data ophalen...';

            try {
                // Fetch from both sources
                const [dbData, apiData] = await Promise.all([
                    fetch(`${API_BASE}/riders/${RIDER_ID}`).then(r => r.json()),
                    fetch(`${ZWIFT_API}/riders/${RIDER_ID}`).then(r => r.json())
                ]);

                displayBasicInfo(dbData, apiData);
                displayPowerData(dbData, apiData);
                displaySyncInfo(dbData);

                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ Data succesvol geladen';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Fout bij laden: ' + error.message;
                console.error(error);
            }
        }

        function displaySyncInfo(dbData) {
            const syncInfoEl = document.getElementById('sync-info');
            const lastSynced = new Date(dbData.last_synced);
            const now = new Date();
            const diffMs = now - lastSynced;
            const diffMin = Math.floor(diffMs / 60000);
            
            syncInfoEl.innerHTML = `
                <strong>Laatste sync:</strong> ${lastSynced.toLocaleString('nl-NL')} 
                (${diffMin} minuten geleden)
            `;
        }

        function displayBasicInfo(dbData, apiData) {
            const basicInfoEl = document.getElementById('basic-info');
            
            const fields = [
                { key: 'name', label: 'Naam', dbKey: 'name', apiKey: 'name' },
                { key: 'weight', label: 'Gewicht (kg)', dbKey: 'weight', apiKey: 'weight' },
                { key: 'height', label: 'Lengte (cm)', dbKey: 'height', apiKey: 'height' },
                { key: 'ftp', label: 'FTP (W)', dbKey: 'zp_ftp', apiKey: 'zpFTP' },
                { key: 'velo', label: 'vELO Rating', dbKey: 'race_current_rating', apiKey: 'race.current.rating' },
                { key: 'category', label: 'Categorie', dbKey: 'zp_category', apiKey: 'zpCategory' },
            ];

            let html = '<table><thead><tr><th>Veld</th><th>Database</th><th>API</th><th>Status</th></tr></thead><tbody>';

            fields.forEach(field => {
                const dbValue = getNestedValue(dbData, field.dbKey);
                const apiValue = getNestedValue(apiData, field.apiKey);
                const status = compareValues(dbValue, apiValue);
                
                html += `
                    <tr>
                        <td><strong>${field.label}</strong></td>
                        <td>${formatValue(dbValue)}</td>
                        <td>${formatValue(apiValue)}</td>
                        <td class="${status.class}">${status.icon} ${status.text}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            basicInfoEl.innerHTML = html;
        }

        function displayPowerData(dbData, apiData) {
            const powerDataEl = document.getElementById('power-data');
            
            const powerFields = [
                { key: 'wkg5', label: '5s (W/kg)', dbKey: 'power_wkg5', apiKey: 'power.wkg5' },
                { key: 'wkg15', label: '15s (W/kg)', dbKey: 'power_wkg15', apiKey: 'power.wkg15' },
                { key: 'wkg30', label: '30s (W/kg)', dbKey: 'power_wkg30', apiKey: 'power.wkg30' },
                { key: 'wkg60', label: '1m (W/kg)', dbKey: 'power_wkg60', apiKey: 'power.wkg60' },
                { key: 'wkg120', label: '2m (W/kg)', dbKey: 'power_wkg120', apiKey: 'power.wkg120' },
                { key: 'wkg300', label: '5m (W/kg)', dbKey: 'power_wkg300', apiKey: 'power.wkg300' },
                { key: 'wkg1200', label: '20m (W/kg)', dbKey: 'power_wkg1200', apiKey: 'power.wkg1200' },
                { key: 'w5', label: '5s (W)', dbKey: 'power_w5', apiKey: 'power.w5' },
                { key: 'w15', label: '15s (W)', dbKey: 'power_w15', apiKey: 'power.w15' },
                { key: 'w30', label: '30s (W)', dbKey: 'power_w30', apiKey: 'power.w30' },
                { key: 'w60', label: '1m (W)', dbKey: 'power_w60', apiKey: 'power.w60' },
                { key: 'w120', label: '2m (W)', dbKey: 'power_w120', apiKey: 'power.w120' },
                { key: 'w300', label: '5m (W)', dbKey: 'power_w300', apiKey: 'power.w300' },
                { key: 'w1200', label: '20m (W)', dbKey: 'power_w1200', apiKey: 'power.w1200' },
                { key: 'cp', label: 'Critical Power', dbKey: 'power_cp', apiKey: 'power.CP' },
                { key: 'awc', label: 'AWC', dbKey: 'power_awc', apiKey: 'power.AWC' },
            ];

            let html = '<table><thead><tr><th>Interval</th><th>Database</th><th>API (eerste waarde)</th><th>API (volledig)</th><th>Status</th></tr></thead><tbody>';

            powerFields.forEach(field => {
                let dbValue = getNestedValue(dbData, field.dbKey);
                let apiValue = getNestedValue(apiData, field.apiKey);
                let apiDisplay = apiValue;
                
                // Extract first element from array if it's an array
                if (Array.isArray(apiValue)) {
                    apiDisplay = `[${apiValue[0]}, ${apiValue[1]}, ${apiValue[2]}]`;
                    apiValue = apiValue[0];
                }
                
                const status = compareValues(dbValue, apiValue, 0.01); // 0.01 tolerance
                
                html += `
                    <tr>
                        <td><strong>${field.label}</strong></td>
                        <td>${formatValue(dbValue, 2)}</td>
                        <td>${formatValue(apiValue, 2)}</td>
                        <td style="font-size: 0.9em; color: #6b7280;">${formatValue(apiDisplay)}</td>
                        <td class="${status.class}">${status.icon} ${status.text}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            powerDataEl.innerHTML = html;
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current?.[key], obj);
        }

        function formatValue(value, decimals = null) {
            if (value === null || value === undefined) return '<em style="color: #9ca3af;">NULL</em>';
            if (typeof value === 'number') {
                return decimals !== null ? value.toFixed(decimals) : value;
            }
            if (typeof value === 'string' && value.length > 50) {
                return value.substring(0, 50) + '...';
            }
            return value;
        }

        function compareValues(dbVal, apiVal, tolerance = 0) {
            if (dbVal === null || dbVal === undefined) {
                if (apiVal === null || apiVal === undefined) {
                    return { class: 'match', icon: '‚ö™', text: 'Beide NULL' };
                }
                return { class: 'missing', icon: '‚ö†Ô∏è', text: 'Ontbreekt in DB' };
            }
            if (apiVal === null || apiVal === undefined) {
                return { class: 'mismatch', icon: '‚ùå', text: 'Niet in API' };
            }

            // Numeric comparison with tolerance
            if (typeof dbVal === 'number' && typeof apiVal === 'number') {
                const diff = Math.abs(dbVal - apiVal);
                if (diff <= tolerance) {
                    return { class: 'match', icon: '‚úÖ', text: 'Match' };
                }
                return { class: 'mismatch', icon: '‚ùå', text: `Verschil: ${diff.toFixed(3)}` };
            }

            // String comparison
            if (dbVal === apiVal || String(dbVal) === String(apiVal)) {
                return { class: 'match', icon: '‚úÖ', text: 'Match' };
            }
            
            return { class: 'mismatch', icon: '‚ùå', text: 'Verschilt' };
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
