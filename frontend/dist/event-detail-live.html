<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Details - Live Data</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 20px;
      color: #667eea;
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      padding: 20px;
      border-radius: 8px;
      color: #c33;
      margin: 20px 0;
    }

    .header-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .event-title {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .event-meta {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      margin-top: 15px;
      color: #64748b;
      font-size: 14px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .meta-item strong {
      color: #2d3748;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card .label {
      font-size: 12px;
      color: #718096;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
      color: #2d3748;
    }

    .stat-card .sub {
      font-size: 13px;
      color: #a0aec0;
      margin-top: 5px;
    }

    .rider-highlight {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .rider-highlight h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .rider-stats {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .rider-stat {
      flex: 1;
      min-width: 150px;
    }

    .rider-stat .label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .rider-stat .value {
      font-size: 24px;
      font-weight: 700;
    }

    .results-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .section-header {
      padding: 20px;
      background: #2d3748;
      color: white;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f7fafc;
      position: sticky;
      top: 0;
    }

    th {
      padding: 12px 10px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 12px 10px;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    tbody tr.highlight-row {
      background: #fef3c7;
      font-weight: 600;
    }

    tbody tr.highlight-row:hover {
      background: #fde68a;
    }

    tbody tr.team-member-row {
      background: #d1fae5;
      font-weight: 500;
    }

    tbody tr.team-member-row:hover {
      background: #a7f3d0;
    }

    tbody tr.team-member-row {
      background: #d1fae5;
      font-weight: 500;
    }

    tbody tr.team-member-row:hover {
      background: #a7f3d0;
    }

    .position-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 14px;
    }

    .pos-1 { background: #ffd700; color: #000; }
    .pos-2 { background: #c0c0c0; color: #000; }
    .pos-3 { background: #cd7f32; color: #fff; }
    .pos-other { background: #e2e8f0; color: #4a5568; }

    .velo-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 13px;
      min-width: 50px;
    }

    .velo-1 { background: #c79dff; color: #fff; }
    .velo-2 { background: #8b5cf6; color: #fff; }
    .velo-3 { background: #7c3aed; color: #fff; }
    .velo-4 { background: #6d28d9; color: #fff; }
    .velo-5 { background: #5b21b6; color: #fff; }

    .trend {
      font-size: 12px;
      margin-left: 6px;
      font-weight: 600;
    }

    .trend.up { color: #10b981; }
    .trend.down { color: #ef4444; }
    .trend.neutral { color: #94a3b8; }

    .power-cell {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      text-align: right;
    }

    .rider-name {
      font-weight: 500;
      color: #2d3748;
    }

    .team-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      background: #e2e8f0;
      color: #4a5568;
      margin-left: 6px;
    }

    .category-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .cat-A { background: #ef4444; color: white; }
    .cat-B { background: #f59e0b; color: white; }
    .cat-C { background: #10b981; color: white; }
    .cat-D { background: #3b82f6; color: white; }

    .time-display {
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 1200px) {
      .power-cell { font-size: 11px; }
      th, td { padding: 8px 5px; font-size: 12px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="./rider-results-live.html" class="back-link">‚Üê Terug naar Rider Results</a>
    
    <div id="loading" class="loading">
      ‚è≥ Loading event details...
    </div>

    <div id="error" class="error" style="display:none;"></div>

    <div id="content" style="display:none;">
      <!-- Event Header -->
      <div class="header-section">
        <h1 class="event-title" id="event-title">-</h1>
        <div class="event-meta">
          <div class="meta-item">
            <span>üìÖ</span>
            <span id="event-date">-</span>
          </div>
          <div class="meta-item">
            <span>üèÅ</span>
            <strong id="event-type">-</strong>
          </div>
          <div class="meta-item">
            <span>üìè</span>
            <span><strong id="event-distance">-</strong> km</span>
          </div>
          <div class="meta-item">
            <span>‚õ∞Ô∏è</span>
            <span><strong id="event-elevation">-</strong> m</span>
          </div>
          <div class="meta-item">
            <span>üë•</span>
            <span><strong id="event-riders">-</strong> deelnemers</span>
          </div>
        </div>
      </div>

      <!-- Rider Highlight (if viewing specific rider) -->
      <div id="rider-highlight" class="rider-highlight" style="display:none;">
        <h2>üèÜ Jouw Race Performance</h2>
        <div class="rider-stats">
          <div class="rider-stat">
            <div class="label">Positie</div>
            <div class="value" id="rider-position">-</div>
          </div>
          <div class="rider-stat">
            <div class="label">vELO Rating</div>
            <div class="value" id="rider-velo">-</div>
          </div>
          <div class="rider-stat">
            <div class="label">vELO Change</div>
            <div class="value" id="rider-velo-change">-</div>
          </div>
          <div class="rider-stat">
            <div class="label">Race Tijd</div>
            <div class="value" id="rider-time">-</div>
          </div>
          <div class="rider-stat">
            <div class="label">Avg W/kg</div>
            <div class="value" id="rider-wkg">-</div>
          </div>
        </div>
      </div>

      <!-- Event Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Winnaar</div>
          <div class="value" id="stat-winner">-</div>
          <div class="sub" id="stat-winner-time">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Gem. Tijd</div>
          <div class="value" id="stat-avg-time">-</div>
          <div class="sub">Over alle finishers</div>
        </div>
        <div class="stat-card">
          <div class="label">Gem. W/kg</div>
          <div class="value" id="stat-avg-wkg">-</div>
          <div class="sub">Gemiddelde inspanning</div>
        </div>
        <div class="stat-card">
          <div class="label">Hoogste vELO</div>
          <div class="value" id="stat-max-velo">-</div>
          <div class="sub" id="stat-max-velo-name">-</div>
        </div>
      </div>

      <!-- Full Results Table -->
      <div class="results-section">
        <div class="section-header">
          <span>üìä Complete Race Results</span>
          <span id="results-count">0 riders</span>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width: 50px;">Pos</th>
              <th style="min-width: 200px;">Rider</th>
              <th style="width: 80px;">vELO</th>
              <th style="width: 80px;">Change</th>
              <th style="width: 80px;">Categorie</th>
              <th style="width: 90px;">Tijd</th>
              <th style="width: 80px;">Gap</th>
              <th style="width: 70px;">Avg W/kg</th>
              <th style="width: 60px;">5s</th>
              <th style="width: 60px;">15s</th>
              <th style="width: 60px;">30s</th>
              <th style="width: 60px;">1m</th>
              <th style="width: 60px;">2m</th>
              <th style="width: 60px;">5m</th>
              <th style="width: 60px;">20m</th>
            </tr>
          </thead>
          <tbody id="results-table">
            <!-- Results loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Get eventId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventId');
    const highlightRiderId = parseInt(urlParams.get('riderId') || '150437');
    let myRiderIds = [];

    if (!eventId) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = '‚ùå Geen Event ID opgegeven';
      document.getElementById('error').style.display = 'block';
    } else {
      loadEventDetails();
    }

    function formatTime(seconds) {
      if (!seconds) return '-';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function formatGap(gap) {
      if (!gap || gap === 0) return '-';
      if (gap < 60) return `+${gap.toFixed(1)}s`;
      const mins = Math.floor(gap / 60);
      const secs = Math.floor(gap % 60);
      return `+${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function loadEventDetails() {
      try {
        // Load my rider IDs for highlighting
        try {
          const myRidersResponse = await fetch(`./api/results/my-rider-ids`);
          const myRidersData = await myRidersResponse.json();
          if (myRidersData.success) {
            myRiderIds = myRidersData.riderIds || [];
            console.log(`My riders: ${myRiderIds.length}`);
          }
        } catch (error) {
          console.warn('Could not load my rider IDs:', error);
        }
            console.warn('Could not load team members:', error);
          }
        }
        const response = await fetch(`https://api.zwiftracing.app/api/public/results/${eventId}`, {
          headers: { 'Authorization': '650c6d2fc4ef6858d74cbef1' }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        // Update header
        document.getElementById('event-title').textContent = data.title || 'Unknown Event';
        document.getElementById('event-date').textContent = new Date(data.time * 1000).toLocaleString('nl-NL', {
          day: '2-digit',
          month: 'long',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('event-type').textContent = `${data.type || 'Race'} - ${data.subType || 'Unknown'}`;
        document.getElementById('event-distance').textContent = data.distance ? (data.distance / 1000).toFixed(1) : '-';
        document.getElementById('event-elevation').textContent = data.elevation || 0;
        document.getElementById('event-riders').textContent = data.results?.length || 0;

        const results = data.results || [];
        
        // Find highlighted rider
        const highlightedRider = results.find(r => r.riderId === highlightRiderId);
        
        if (highlightedRider) {
          document.getElementById('rider-highlight').style.display = 'block';
          document.getElementById('rider-position').textContent = `${highlightedRider.position}/${results.length}`;
          document.getElementById('rider-velo').textContent = Math.round(highlightedRider.rating || 0);
          
          const veloChange = Math.round(highlightedRider.ratingDelta || 0);
          const changeSpan = document.getElementById('rider-velo-change');
          changeSpan.textContent = veloChange > 0 ? `+${veloChange}` : veloChange;
          changeSpan.style.color = veloChange > 0 ? '#10b981' : veloChange < 0 ? '#ef4444' : '#94a3b8';
          
          document.getElementById('rider-time').textContent = formatTime(highlightedRider.time);
          document.getElementById('rider-wkg').textContent = highlightedRider.wkgAvg?.toFixed(2) || '-';
        }

        // Calculate statistics
        if (results.length > 0) {
          const winner = results[0];
          document.getElementById('stat-winner').textContent = winner.name?.split(' ')[0] || 'Unknown';
          document.getElementById('stat-winner-time').textContent = formatTime(winner.time);

          const avgTime = results.reduce((sum, r) => sum + (r.time || 0), 0) / results.length;
          document.getElementById('stat-avg-time').textContent = formatTime(avgTime);

          const resultsWithWkg = results.filter(r => r.wkgAvg);
          if (resultsWithWkg.length > 0) {
            const avgWkg = resultsWithWkg.reduce((sum, r) => sum + r.wkgAvg, 0) / resultsWithWkg.length;
            document.getElementById('stat-avg-wkg').textContent = avgWkg.toFixed(2);
          }

          const maxVeloRider = results.reduce((max, r) => (r.rating || 0) > (max.rating || 0) ? r : max, results[0]);
          document.getElementById('stat-max-velo').textContent = Math.round(maxVeloRider.rating || 0);
          document.getElementById('stat-max-velo-name').textContent = maxVeloRider.name?.split(' ')[0] || 'Unknown';
        }

        // Render results table
        const tbody = document.getElementById('results-table');
        tbody.innerHTML = '';
        document.getElementById('results-count').textContent = `${results.length} riders`;

        results.forEach(rider => {
          const row = document.createElement('tr');
          if (rider.riderId === highlightRiderId) {
            row.classmyRiderIds.length > 0 && myRid
          } else if (teamMemberIds.length > 0 && teamMemberIds.includes(rider.riderId)) {
            row.className = 'team-member-row';
          }

          const posClass = rider.position === 1 ? 'pos-1' : 
                          rider.position === 2 ? 'pos-2' : 
                          rider.position === 3 ? 'pos-3' : 'pos-other';

          const veloRank = Math.ceil((rider.rating || 1400) / 200);
          const veloChange = Math.round(rider.ratingDelta || 0);
          const veloTrend = veloChange > 0 ? `<span class="trend up">‚ñ≤${veloChange}</span>` : 
                           veloChange < 0 ? `<span class="trend down">‚ñº${Math.abs(veloChange)}</span>` : 
                           '<span class="trend neutral">‚Äî</span>';

          const category = rider.category || '-';
          const catClass = `cat-${category.charAt(0)}`;

          const teamBadge = rider.teamName ? `<span class="team-badge">${rider.teamName}</span>` : '';

          row.innerHTML = `
            <td><span class="position-badge ${posClass}">${rider.position}</span></td>
            <td>
              <span class="rider-name">${rider.name || 'Unknown'}</span>
              ${teamBadge}
            </td>
            <td>
              <span class="velo-badge velo-${veloRank}">${Math.round(rider.rating || 0)}</span>
            </td>
            <td>${veloTrend}</td>
            <td><span class="category-badge ${catClass}">${category}</span></td>
            <td class="time-display">${formatTime(rider.time)}</td>
            <td class="time-display">${formatGap(rider.gap)}</td>
            <td>${rider.wkgAvg?.toFixed(2) || '-'}</td>
            <td class="power-cell">${rider.wkg5?.toFixed(1) || '-'}</td>
            <td class="power-cell">${rider.wkg15?.toFixed(1) || '-'}</td>
            <td class="power-cell">${rider.wkg30?.toFixed(1) || '-'}</td>
            <td class="power-cell">${rider.wkg60?.toFixed(1) || '-'}</td>
            <td class="power-cell">${rider.wkg120?.toFixed(1) || '-'}</td>
            <td class="power-cell">${rider.wkg300?.toFixed(1) || '-'}</td>
            <td class="power-cell">${rider.wkg1200?.toFixed(1) || '-'}</td>
          `;

          tbody.appendChild(row);
        });

        // Show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

      } catch (error) {
        console.error('Error loading event:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').innerHTML = `
          <strong>‚ùå Fout bij laden event details:</strong><br>
          ${error.message}<br><br>
          <small>Event ID: ${eventId}</small>
        `;
        document.getElementById('error').style.display = 'block';
      }
    }
  </script>
</body>
</html>
