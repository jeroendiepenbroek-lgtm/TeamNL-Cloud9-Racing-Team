<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rider Results - CloudRacer-9 Racing Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #60a5fa;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #3b82f6;
    }

    .rider-header {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .rider-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid #3b82f6;
    }

    .rider-info h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .rider-badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: bold;
    }

    .category-A { background: #ef4444; color: white; }
    .category-B { background: #f59e0b; color: white; }
    .category-C { background: #10b981; color: white; }
    .category-D { background: #3b82f6; color: white; }

    .velo-badge {
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
      border: 1px solid #8b5cf6;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: #3b82f6;
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
    }

    .stat-label {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-trend {
      font-size: 0.75rem;
      margin-top: 5px;
    }

    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }

    .section {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.5rem;
      color: #60a5fa;
    }

    .race-count {
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }

    th {
      color: #94a3b8;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    td {
      color: #e2e8f0;
    }

    .event-name {
      color: #60a5fa;
      cursor: pointer;
      transition: color 0.2s;
    }

    .event-name:hover {
      color: #3b82f6;
      text-decoration: underline;
    }

    .position-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.875rem;
    }

    .position-1 { background: #fbbf24; color: #1e293b; }
    .position-2 { background: #94a3b8; color: #1e293b; }
    .position-3 { background: #cd7f32; color: white; }
    .position-top5 { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .position-top10 { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .position-other { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }

    .velo-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .velo-value {
      font-weight: bold;
      color: #a78bfa;
    }

    .velo-change {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .velo-up {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .velo-down {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .power-cell {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .power-highlight {
      color: #fbbf24;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .rider-header {
        flex-direction: column;
        text-align: center;
      }

      table {
        font-size: 0.75rem;
      }

      th, td {
        padding: 8px 4px;
      }

      .power-cell {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="./results-dashboard.html" class="back-link">← Terug naar Dashboard</a>
    
    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Rider gegevens laden...</p>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const riderId = urlParams.get('riderId') || '150437';
    const limit = urlParams.get('limit') || '50';

    async function loadRiderResults() {
      try {
        const response = await fetch(`./api/results/rider/${riderId}/scrape?limit=${limit}`);
        const data = await response.json();
        
        if (data.success) {
          renderRiderResults(data);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        console.error('Error loading rider results:', error);
        document.getElementById('content').innerHTML = `
          <div class="loading">
            <p style="color: #ef4444;">❌ Fout bij laden resultaten: ${error.message}</p>
          </div>
        `;
      }
    }

    function renderRiderResults(data) {
      const { riderId, races, stats } = data;
      
      // Calculate statistics
      const totalRaces = races.length;
      const wins = races.filter(r => r.position === 1).length;
      const podiums = races.filter(r => r.position <= 3).length;
      const top5 = races.filter(r => r.position <= 5).length;
      const avgPosition = totalRaces > 0 
        ? (races.reduce((sum, r) => sum + r.position, 0) / totalRaces).toFixed(1) 
        : 0;
      const avgWkg = totalRaces > 0 
        ? (races.reduce((sum, r) => sum + (r.wkgAvg || 0), 0) / totalRaces).toFixed(2) 
        : 0;
      
      // Get rider name and vELO from most recent race
      const latestRace = races[0];
      const riderName = `Rider ${riderId}`;
      const currentVelo = latestRace?.veloRating || 0;
      const category = latestRace?.category || 'B';
      
      // Calculate vELO trend (last 5 races)
      const recentRaces = races.slice(0, 5);
      const veloTrend = recentRaces.length >= 2 
        ? recentRaces[0].veloRating - recentRaces[recentRaces.length - 1].veloBefore 
        : 0;
      
      let html = `
        <!-- Rider Header -->
        <div class="rider-header">
          <img src="https://ui-avatars.com/api/?name=${riderName}&background=3b82f6&color=fff&size=100" 
               alt="${riderName}" 
               class="rider-avatar">
          <div class="rider-info">
            <h1>${riderName}</h1>
            <div class="rider-badges">
              <span class="badge category-${category}">${category}</span>
              <span class="badge velo-badge">vELO ${currentVelo}</span>
              ${veloTrend !== 0 ? `
                <span class="badge ${veloTrend > 0 ? 'velo-up' : 'velo-down'}">
                  ${veloTrend > 0 ? '↑' : '↓'} ${Math.abs(veloTrend)} (laatste 5 races)
                </span>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">vELO Rating</div>
            <div class="stat-value">${currentVelo}</div>
            ${veloTrend !== 0 ? `
              <div class="stat-trend ${veloTrend > 0 ? 'trend-up' : 'trend-down'}">
                ${veloTrend > 0 ? '↑' : '↓'} ${Math.abs(veloTrend)} afgelopen 5 races
              </div>
            ` : ''}
          </div>
          <div class="stat-card">
            <div class="stat-label">Totaal Races</div>
            <div class="stat-value">${totalRaces}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Overwinningen</div>
            <div class="stat-value">${wins}</div>
            <div class="stat-trend">${totalRaces > 0 ? ((wins / totalRaces) * 100).toFixed(0) : 0}% win rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Podiums</div>
            <div class="stat-value">${podiums}</div>
            <div class="stat-trend">${totalRaces > 0 ? ((podiums / totalRaces) * 100).toFixed(0) : 0}% podium rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Top 5</div>
            <div class="stat-value">${top5}</div>
            <div class="stat-trend">${totalRaces > 0 ? ((top5 / totalRaces) * 100).toFixed(0) : 0}% top 5 rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Gem. Positie</div>
            <div class="stat-value">${avgPosition}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Gem. W/kg</div>
            <div class="stat-value">${avgWkg}</div>
          </div>
        </div>

        <!-- Race History Table -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Race Geschiedenis</h2>
            <span class="race-count">${totalRaces} races</span>
          </div>
          
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Event</th>
                  <th>Positie</th>
                  <th>vELO</th>
                  <th>Cat</th>
                  <th>Tijd</th>
                  <th>Avg W/kg</th>
                  <th class="power-cell">Power Intervals</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      races.forEach(race => {
        const date = new Date(race.eventDate).toLocaleDateString('nl-NL', { 
          day: '2-digit', 
          month: '2-digit' 
        });
        
        const positionClass = race.position === 1 ? 'position-1' :
                              race.position === 2 ? 'position-2' :
                              race.position === 3 ? 'position-3' :
                              race.position <= 5 ? 'position-top5' :
                              race.position <= 10 ? 'position-top10' : 'position-other';
        
        const veloChangeClass = race.veloChange > 0 ? 'velo-up' : 'velo-down';
        
        const time = race.timeSeconds 
          ? `${Math.floor(race.timeSeconds / 60)}:${String(Math.floor(race.timeSeconds % 60)).padStart(2, '0')}`
          : '-';
        
        html += `
          <tr>
            <td>${date}</td>
            <td>
              <span class="event-name" onclick="window.location.href='./event-detail-live.html?eventId=${race.eventId}&riderId=${riderId}'">
                ${race.eventName}
              </span>
            </td>
            <td>
              <span class="position-badge ${positionClass}">
                ${race.position}/${race.totalRiders}
              </span>
            </td>
            <td>
              <div class="velo-cell">
                <span class="velo-value">${race.veloRating}</span>
                <span class="velo-change ${veloChangeClass}">
                  ${race.veloChange > 0 ? '+' : ''}${race.veloChange}
                </span>
              </div>
            </td>
            <td><span class="badge category-${race.category}">${race.category}</span></td>
            <td>${time}</td>
            <td>${race.wkgAvg ? race.wkgAvg.toFixed(2) : '-'}</td>
            <td class="power-cell">
              ${race.wkg5 ? `5s: <span class="power-highlight">${race.wkg5.toFixed(1)}</span>` : ''} 
              ${race.wkg60 ? `1m: ${race.wkg60.toFixed(1)}` : ''} 
              ${race.wkg300 ? `5m: ${race.wkg300.toFixed(1)}` : ''}
            </td>
          </tr>
        `;
      });
      
      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      document.getElementById('content').innerHTML = html;
    }

    // Load rider results on page load
    loadRiderResults();
  </script>
</body>
</html>
